<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>Monitoring Cassandra cluster with Prometheus Operator</title>
<meta name="description" content="Our current project has several microservices. All of them are dockerized and deployed to a Kubernetes ecosystem. There is a Cassandra cluster running outsid...">

<link rel="stylesheet" href="/css/main.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="canonical" href="riyasyash.github.io/blog/2019/monitoring-cassandra-with-prometheus-operator/">
<link rel="alternate" type="application/rss+xml" title="Riyas P" href="riyasyash.github.io/feed.xml" />

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', '', 'auto');
  ga('send', 'pageview');
</script>


</head>
<body>
  <header class="site-header">
  <div class="container">
    <input type="checkbox" id="toggleNavbar">
    <h1 class="logo"><a href="/"><span></span> <small></small></a></h1>
    <label for="toggleNavbar" role="button" class="toggle-navbar-button">
      <i class="icon icon-menu"></i>
      <i class="icon icon-cross"></i>
    </label>
    <nav class="navbar">
      <ul>
        <li><a href="/" title="Home">Home</a></li>
        
          <li><a href="/about" title="About">About</a></li>
        
          <li><a href="/blog" title="Blog">Blog</a></li>
        
      </ul>
    </nav>
  </div>
</header>


<main class="main-container">
  <div class="container">
    <article role="article" class="post">

  <div class="card">
    <header class="post-header">
      <h1 class="post-title">Monitoring Cassandra cluster with Prometheus Operator</h1>
      <em class="post-meta">
        <time>Aug 15, 2019</time>
      </em>
    </header>

    <div class="post-content">
      
        <figure class="post-thumbnail ">
          <img src="https://miro.medium.com/max/1400/1*bcEgqHigN6exIdG0HronRQ.jpeg" alt="Monitoring Cassandra cluster with Prometheus Operator">
        </figure>
      
      <p>Our current project has several microservices. All of them are dockerized and deployed to a Kubernetes ecosystem. There is a Cassandra cluster running outside the Kubernetes cluster and it is being used by most of our services.</p>

<p>On the monitoring front, we have Prometheus Operator, beautiful Grafana dashboards and Loki to aggregate the logs generated by the services.</p>

<p>All of these tools, namely Prometheus, Grafana, and Loki are also running within the Kuberenetes cluster. So it was pretty straightforward to set up and configure these for our services.</p>

<p>Then came the task of monitoring the Cassandra cluster. Since it is running outside of Kubernetes cluster, we have to do the following things.</p>

<ul>
  <li>Export the metrics from the Cassandra cluster</li>
  <li>Scrape the exported metrics from Cassandra nodes</li>
  <li>Create a dashboard on Grafana with these metrics</li>
</ul>

<h2 id="step-1-export-the-metrics-from-the-cassandra-cluster">Step 1: Export the metrics from the Cassandra cluster</h2>

<p>We found this tool cassandra_exporter which is a fork of JMX exporter and is fairly easy to install and configure. Please go through the README of the project. Configure the metrics you want to export and the port on which you have to export those on all the nodes in the cluster.</p>

<p>At the end of a successful configuration, you can get the metrics from your Cassandra node on <code>localhost:listenPort/</code> or <code>localhost:listenPort/metrics</code></p>

<h2 id="step-2-scrape-the-exported-metrics-from-cassandra-nodes">Step 2: Scrape the exported metrics from Cassandra nodes</h2>

<p>Implementing the monitoring for the Cassandra cluster became a little tricky since the Prometheus Operator runs within the Kubernetes cluster and the Kubernetes cluster doesn’t know anything about the Cassandra cluster.</p>

<p>Let me circle back to the above statement after diving into the Prometheus Operator.</p>

<h2 id="prometheus-operator">Prometheus Operator</h2>

<blockquote>
  <p>Operators were introduced by CoreOS as a class of software that operates other software, putting operational knowledge collected by humans into software. Read more in the original blog post, Introducing Operators. The Prometheus Operator serves to make running Prometheus on top of Kubernetes as easy as possible while preserving Kubernetes-native configuration options.</p>
</blockquote>

<p>To simplify the process of monitoring services in a Kubernetes cluster, the Prometheus Operator introduces additional resources:</p>

<ul>
  <li>Prometheus</li>
  <li>ServiceMonitor</li>
  <li>AlertManager</li>
</ul>

<p><br /></p>
<figure class="image"><center>
    <img src="https://miro.medium.com/max/1400/1*6KI8wlyWwLwPYgt_SP1CCA.png" alt="src: https://coreos.com/operators/prometheus/docs/latest/user-guides/getting-started.html" />
    <figcaption>src: https://coreos.com/operators/prometheus/docs/latest/user-guides/getting-started.html</figcaption>
</center>
  </figure>
<p><br /></p>

<p>As evident from the architecture diagram, ServiceMonitor helps you to define how to group services for monitoring. Based on the ServiceMonitor definition Prometheus Operator creates the scrape configuration. This makes our job easier.</p>

<h2 id="problem">Problem</h2>

<p>This is excellent if the service is running inside the Kubernetes cluster, but the Cassandra cluster is running outside of it. Hence, there are no services or service definitions for the same and we cannot easily monitor them.</p>

<h2 id="workaround">Workaround</h2>

<p>Let’s first implement a workaround for one node in the Cassandra cluster,</p>

<h3 id="create-a-kubernetes-endpoint-to-the-cassandra-node">Create a Kubernetes endpoint to the Cassandra node</h3>

<pre><code class="language-yaml">
apiVersion: v1
kind: Endpoints
metadata:
    name: cassandra-metrics
    labels:
        release: prometheus-operator
    namespace: monitoring
subsets:
    - addresses:
      - ip: &lt;ip address of the cassandra node&gt;
      ports:
      - name: metrics
        port: 8080
        protocol: TCP

</code></pre>

<h3 id="create-a-service-that-listens-to-this-endpoint">Create a service that listens to this endpoint</h3>

<pre><code class="language-yaml">apiVersion: v1
kind: Service
metadata:
    name: cassandra-metrics
    namespace: monitoring
    labels:
        release: prometheus-operator
        k8s-app: cassandra-metrics
spec:
    type: ExternalName
    externalName: &lt;ip address of the cassandra node&gt;
    ports:
    - name: metrics
      port: 8080
      protocol: TCP
      targetPort: 8080

</code></pre>

<h3 id="create-a-servicemonitor-that-will-monitor-the-above-service">Create a ServiceMonitor that will monitor the above service</h3>

<pre><code class="language-yaml">apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
    name: cassandra-metrics-sm
    labels:
        release: prometheus-operator
        prometheus: kube-prometheus
    namespace: monitoring
spec:
    selector:
        matchLabels:
            release: prometheus-operator
            k8s-app: cassandra-metrics
        namespaceSelector:
            matchNames:
            - monitoring
    endpoints:
    - port: metrics
      interval: 10s
      honorLabels: true
      path: /metrics
</code></pre>

<p>At this point, you will be able to see the service monitor cassandra-metrics-sm under service discovery and targets in your Prometheus UI. Something like in the image below.</p>

<p><br /></p>
<figure class="image"><center>
    <img src="https://miro.medium.com/max/1400/1*VIHJaTlV_d96R1G2asR_cQ.png" alt="" />
    <figcaption>screenshot</figcaption>
</center>
  </figure>
<p><br /></p>

<p>Now let’s add more nodes from the Cassandra cluster to the ServiceMonitor. If you remember the architecture diagram above, this is a no brainer. We just have to create endpoints for remaining instances and create services to map to those endpoints. We don’t have to create another ServiceMonitor since we need all the services to grouped under the same.</p>

<p>If the configurations are complete you can see an increase in the number of active targets.</p>

<h2 id="step-3-create-the-grafana-dashboard">Step 3: Create the Grafana Dashboard</h2>

<p>There are lots of Grafana dashboards available online you can use any one of them including the one in cassandra_exporter documentation or you can create one of your own.</p>

<h2 id="conclusion">Conclusion</h2>

<p>We discussed how we can use the Prometheus Operator running inside the Kubernetes cluster to monitor an externally running Cassandra cluster. We can use the same approach to monitor other services and instances as well. But remember to use a valid metrics exporter.</p>

    </div>

    
<hr>

<aside id="comments" class="disqus">
  <h3><i class="icon icon-comments-o"></i> Comments</h3>
  <div id="disqus_thread"></div>
  <script>
    var disqus_config = function() {
      this.page.url = 'riyasyash.github.io/blog/2019/monitoring-cassandra-with-prometheus-operator/';
      this.page.identifier = '/blog/2019/monitoring-cassandra-with-prometheus-operator';
    };
    (function() {
      var d = document,
      s = d.createElement('script');
      s.src = '//riyashyash.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
</aside>


  </div>

</article>

  </div>
</main>

<footer class="site-footer">
  <div class="container">
    <ul class="social">
  <li><a href="https://github.com/riyasyash" target="_blank"><i class="icon icon-github"></i></a></li>
  <li><a href="https://twitter.com/riyasyash" target="_blank"><i class="icon icon-twitter"></i></a></li>
  <li><a href="https://medium.com/@riyasyash" target="_blank"><i class="fa fa-medium"></i></a></li>
  <li><a href="https://linkedin.com/in/riyasyash" target="_blank"><i class="icon icon-linkedin"></i></a></li>
  <li><a href="https://www.instagram.com/riyasyash/" target="_blank"><i class="icon icon-instagram"></i></a></li>
</ul>
    <p class="txt-medium-gray">
      <small>&copy;2020 All rights reserved.</small>
    </p>
  </div>
</footer>


  <a href="https://github.com/riyasyash" target="_blank" class="github-corner"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#337ab7; color:#fff; position: absolute; top: 0; border: 0; right: 0;"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-142422878-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-142422878-1');
</script>

</body>
</html>
